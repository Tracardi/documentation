!function(e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).tracardi=e()}(function(){return function o(i,r,a){function s(t,e){if(!r[t]){if(!i[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(u)return u(t,!0);throw(n=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",n}n=r[t]={exports:{}},i[t][0].call(n.exports,function(e){return s(i[t][1][e]||e)},n,n.exports,o,i,r,a)}return r[t].exports}for(var u="function"==typeof require&&require,e=0;e<a.length;e++)s(a[e]);return s}({1:[function(e,t,n){var s=e("@analytics/global-storage-utils"),u=i(),e=r;function o(e){return u?r(e,"",-1):s.remove(e)}function i(){if(typeof u!==s.undef)return u;try{r("__x","__x"),u=-1!==document.cookie.indexOf("__x"),o("__x")}catch(e){u=!1}return u}function r(e,t,n,o,i,r){if(typeof window!==s.undef){var a=1<arguments.length;return u||(a?s.set(e,t):s.get(e)),a?document.cookie=e+"="+encodeURIComponent(t)+(n?"; expires="+new Date(+new Date+1e3*n).toUTCString()+(o?"; path="+o:"")+(i?"; domain="+i:"")+(r?"; secure":""):""):decodeURIComponent((("; "+document.cookie).split("; "+e+"=")[1]||"").split(";")[0])}}n.getCookie=r,n.hasCookies=i,n.removeCookie=o,n.setCookie=e},{"@analytics/global-storage-utils":2}],2:[function(e,t,o){!function(e){!function(){var n="object"==typeof self&&self.self===self&&self||"object"==typeof e&&e.global===e&&e||void 0;function t(e,t){return n[e]=t}o.get=function(e){return n[e]},o.globalContext=n,o.remove=function(e){t(e)},o.set=t,o.undef="undefined"}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],3:[function(e,t,n){var o=e("@analytics/global-storage-utils"),i=r();function r(){if(typeof i!==o.undef)return i;i=!0;try{typeof localStorage!==o.undef&&typeof JSON!==o.undef||(i=!1),localStorage.setItem(o.undef,o.undef),localStorage.removeItem(o.undef)}catch(e){i=!1}return i}n.getItem=function(e){return i?localStorage.getItem(e):o.get(e)},n.hasLocalStorage=r,n.removeItem=function(e){return i?localStorage.removeItem(e):o.remove(e)},n.setItem=function(e,t){return i?localStorage.setItem(e,t):o.set(e,t)}},{"@analytics/global-storage-utils":2}],4:[function(e,t,n){var a=e("@analytics/global-storage-utils"),s=e("@analytics/cookie-utils"),o=e("@analytics/localstorage-utils"),u=e("@analytics/type-utils");function c(e){var t=e;try{if("true"===(t=JSON.parse(e)))return!0;if("false"===t)return!1;if(u.isObject(t))return t;parseFloat(t)===t&&(t=parseFloat(t))}catch(e){}if(null!==t&&""!==t)return t}var i=o.hasLocalStorage(),r=s.hasCookies();function l(e,t){if(e){var n=g(t),o=!m(n),t=p(n)?c(localStorage.getItem(e)):void 0;if(o&&!u.isUndefined(t))return t;n=h(n)?c(s.getCookie(e)):void 0;if(o&&n)return n;e=a.get(e);return o?e:{localStorage:t,cookie:n,global:e}}}function d(e,t,n){if(e&&!u.isUndefined(t)){var o={},i=g(n),r=JSON.stringify(t),n=!m(i);return p(i)&&(o.localStorage={location:"localStorage",current:t,previous:c(localStorage.getItem(e))},localStorage.setItem(e,r),n)?o.localStorage:h(i)&&(o.cookie={location:"cookie",current:t,previous:c(s.getCookie(e))},s.setCookie(e,r),n)?o.cookie:(o.global={location:"global",current:t,previous:a.get(e)},a.set(e,t),n?o.global:o)}}function f(e,t){if(e){var n=g(t),o=l(e,"*"),t={};return!u.isUndefined(o.localStorage)&&p(n)&&(localStorage.removeItem(e),t.localStorage=o.localStorage),!u.isUndefined(o.cookie)&&h(n)&&(s.removeCookie(e),t.cookie=o.cookie),!u.isUndefined(o.global)&&v(n,"global")&&(a.remove(e),t.global=o.global),t}}function g(e){return e?u.isString(e)?e:e.storage:"any"}function p(e){return i&&v(e,"localStorage")}function h(e){return r&&v(e,"cookie")}function m(e){return"*"===e||"all"===e}function v(e,t){return"any"===e||e===t||m(e)}e={setItem:d,getItem:l,removeItem:f};Object.defineProperty(n,"globalContext",{enumerable:!0,get:function(){return a.globalContext}}),Object.defineProperty(n,"getCookie",{enumerable:!0,get:function(){return s.getCookie}}),Object.defineProperty(n,"hasCookies",{enumerable:!0,get:function(){return s.hasCookies}}),Object.defineProperty(n,"removeCookie",{enumerable:!0,get:function(){return s.removeCookie}}),Object.defineProperty(n,"setCookie",{enumerable:!0,get:function(){return s.setCookie}}),Object.defineProperty(n,"hasLocalStorage",{enumerable:!0,get:function(){return o.hasLocalStorage}}),n.ALL="*",n.ANY="any",n.COOKIE="cookie",n.GLOBAL="global",n.LOCAL_STORAGE="localStorage",n.default=e,n.getItem=l,n.removeItem=f,n.setItem=d},{"@analytics/cookie-utils":1,"@analytics/global-storage-utils":2,"@analytics/localstorage-utils":3,"@analytics/type-utils":5}],5:[function(e,t,n){function o(){}var i="undefined"!=typeof window;function r(e){return"function"==typeof e}function a(e){return"string"==typeof e}function s(e){return e instanceof Element||e instanceof HTMLDocument}n.ARRAY="array",n.BOOLEAN="boolean",n.FUNCTION="function",n.NUMBER="number",n.OBJECT="object",n.STRING="string",n.UNDEFINED="undefined",n.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},n.isBoolean=function(e){return"boolean"==typeof e},n.isBrowser=i,n.isElement=s,n.isEmail=function(e){return!(320<e.length)&&/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(e)},n.isForm=function(e){return s(e)&&"FORM"===e.nodeName},n.isFunction=r,n.isHidden=function(e,t){if(!e||"hidden"===getComputedStyle(e).visibility)return!0;for(;e;){if(null!=t&&e===t)return!1;if("none"===getComputedStyle(e).display)return!0;e=e.parentElement}return!1},n.isNoOp=function(e){if(!r(e))return!1;var t=/{(\r|\n|\s)*}/gm,n=o.toString();return n===(e.toString().match(t)||[""])[0].replace(t,n)},n.isNodeList=function(e){return NodeList.prototype.isPrototypeOf(e)},n.isNull=function(e){return null===e},n.isNumber=function(e){return"number"==typeof e&&!isNaN(e)},n.isObject=function(e){if("object"!=typeof e||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t},n.isRegex=function(e){return e instanceof RegExp},n.isString=a,n.isTruthy=function(e){return!(a(e)&&"false"===e.toLowerCase()||!e)},n.isUndefined=function(e){return void 0===e},n.noOp=o},{}],6:[function(e,t,n){var o,i,r,a;o=this,i=function(){"use strict";function a(e){for(var t=1;t<arguments.length;t++){var n,o=arguments[t];for(n in o)e[n]=o[n]}return e}return function t(s,r){function n(e,t,n){if("undefined"!=typeof document){"number"==typeof(n=a({},r,n)).expires&&(n.expires=new Date(Date.now()+864e5*n.expires)),n.expires&&(n.expires=n.expires.toUTCString()),e=encodeURIComponent(e).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var o,i="";for(o in n)n[o]&&(i+="; "+o,!0!==n[o]&&(i+="="+n[o].split(";")[0]));return document.cookie=e+"="+s.write(t,e)+i}}return Object.create({set:n,get:function(e){if("undefined"!=typeof document&&(!arguments.length||e)){for(var t=document.cookie?document.cookie.split("; "):[],n={},o=0;o<t.length;o++){var i=t[o].split("="),r=i.slice(1).join("=");try{var a=decodeURIComponent(i[0]);if(n[a]=s.read(r,a),e===a)break}catch(e){}}return e?n[e]:n}},remove:function(e,t){n(e,"",a({},t,{expires:-1}))},withAttributes:function(e){return t(this.converter,a({},this.attributes,e))},withConverter:function(e){return t(a({},this.converter,e),this.attributes)}},{attributes:{value:Object.freeze(r)},converter:{value:Object.freeze(s)}})}({read:function(e){return(e='"'===e[0]?e.slice(1,-1):e).replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(e){return encodeURIComponent(e).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}},{path:"/"})},"object"==typeof n&&void 0!==t?t.exports=i():(o="undefined"!=typeof globalThis?globalThis:o||self,r=o.Cookies,(a=o.Cookies=i()).noConflict=function(){return o.Cookies=r,a})},{}],7:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.getCookie=function(e){return i.default.get(e)},n.hasCookiesEnabled=function(){var e="__t_c";i.default.set(e,"1",{expires:1,sameSite:"lax"});var t="1"===i.default.get(e);return i.default.remove(e),t},n.removeCookie=function(e){i.default.remove(e)},n.setCookie=function(e,t,n,o){i.default.set(e,t,{expires:n/1440,sameSite:"lax",path:o})};var i=(e=e("js-cookie"))&&e.__esModule?e:{default:e}},{"js-cookie":6}],8:[function(e,t,n){"use strict";var i=e("./cookies"),r=e("@analytics/storage-utils"),a=e("./utils/hash");function s(t,e){var n,o=Object.keys(t);return Object.getOwnPropertySymbols&&(n=Object.getOwnPropertySymbols(t),e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,n)),o}function u(o){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?s(Object(i),!0).forEach(function(e){var t,n;t=o,e=i[n=e],n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(i)):s(Object(i)).forEach(function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(i,e))})}return o}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function l(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),e}var d=["p","a","div","img","h1","h2","h3","h4","h5","h6","pre","span","li","td","th","button","thin"];var f=function(){function e(){c(this,e),this.dataToSend=[],this.pendingPayload=[],this.timer=null,this.profileId=null,this.sessionId=null,this.apiUrl=null,this.sourceId=null,this.deviceId=null}return l(e,[{key:"setProfileId",value:function(e){this.profileId=e,console.debug("ProfileId set to: ".concat(this.profileId))}},{key:"setSessionId",value:function(e){this.sessionId=e,console.debug("SessionId set to: ".concat(this.sessionId))}},{key:"setSourceId",value:function(e){this.sourceId=e,console.debug("sourceId set to: ".concat(this.sourceId))}},{key:"setApiUrl",value:function(e){this.apiUrl=e}},{key:"collectData",value:function(e){var t=this;Array.isArray(e)?this.pendingPayload=this.pendingPayload.concat(e):this.pendingPayload.push(e),this.timer||(this.timer=setTimeout(function(){t.sendData(!1),t.timer=null},1e3))}},{key:"pushData",value:function(t){var e,n=this,o=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.apiUrl&&this.sourceId&&(null!==this.profileId||null!==this.sessionId)?(e={source:{id:this.sourceId},context:{},events:[],options:{}},this.sessionId&&(e.session={id:this.sessionId}),this.profileId&&(e.profile={id:this.profileId}),this.deviceId&&(e.device={id:this.deviceId}),e.events=t.elements.map(function(e){return{type:"content-viewed",properties:u(u({},e),{},{id:(0,a.fnv1aHash)(e.type,e.tag,e.content)}),tags:["event:signal"],context:{page:{url:t.url,title:document.title}},options:{async:!0}}}),o&&navigator.sendBeacon?(console.debug("Data pushed by beacon"),o=new Blob([JSON.stringify(e)],{type:"application/json"}),navigator.sendBeacon(this.apiUrl,o)?this.pendingPayload=[]:console.error("Failed to send data via Beacon API.")):(console.debug("Data pushed by fetch"),e=JSON.stringify(e),fetch(this.apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:e}).then(function(e){e.ok?n.pendingPayload=[]:console.error("Error sending data:",e.statusText)}).catch(function(e){console.error("Error sending data:",e)}))):console.warn("No proper configuration.")}},{key:"sendData",value:function(){var e,n,t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];0<this.pendingPayload.length&&((e=(e=this.pendingPayload,n=[],e.forEach(function(t){var e=n.find(function(e){return e.content.toLowerCase()===t.content.toLowerCase()});e?(e.duration+=t.duration,e.clickCount+=t.clickCount,e.mouseOverDuration+=t.mouseOverDuration,Array.isArray(e.selectedText)?e.selectedText.push(t.selectedText):e.selectedText=[e.selectedText,t.selectedText],e.duplicateCount+=1):n.push({type:t.type,tag:t.tag,content:t.content,duration:t.duration,mouseOverDuration:t.mouseOverDuration,selectedText:t.selectedText?[t.selectedText]:[],duplicateCount:1,clickCount:0})}),n).filter(function(e){return 1e3<=e.duration})).sort(function(e,t){return e.mouseOverDuration!==t.mouseOverDuration?e.mouseOverDuration-t.mouseOverDuration:e.duration-t.duration}),0<e.length&&(e={url:window.location.href,elements:e},this.pushData(e,t)))}},{key:"flushData",value:function(){this.sendData(!0)}}]),e}(),g=function(){function o(){c(this,o),this.dataSender=new f,this.trackedElements=new Map,this.dataToSend=[];var e,t,n=document.getElementById("tracardi-signal");n?(this.api=n.getAttribute("data-signal-api"),this.token=n.getAttribute("data-signal-token"),this.init()):signalConfig&&null!==(e=signalConfig.source)&&void 0!==e&&e.id&&null!==(t=signalConfig.url)&&void 0!==t&&t.api&&(this.api=null===(t=signalConfig.url)||void 0===t?void 0:t.api,this.token=null===(t=signalConfig.source)||void 0===t?void 0:t.id,this.init())}return l(o,[{key:"init",value:function(){var t=this;"loading"===document.readyState?document.addEventListener("DOMContentLoaded",function(){return t.setupTracking()}):this.setupTracking(),window.addEventListener("beforeunload",function(e){t.sendAllData(),t.dataSender.flushData()})}},{key:"setupTracking",value:function(){var e=(0,i.getCookie)("tracardi-session-id"),t=(0,r.getItem)("tracardi-profile-id");this.dataSender.setApiUrl(this.api),this.dataSender.setSourceId(this.token),e&&this.dataSender.setSessionId(e),t&&this.dataSender.setProfileId(t),this.observeVisibility(),this.trackTabChange(),this.trackMouseOver(),this.trackTextSelection()}},{key:"trackTabChange",value:function(){var e=this;document.addEventListener("visibilitychange",function(){"hidden"===document.visibilityState?(console.debug("Tab hidden"),e.sendAllData(),e.dataSender.flushData()):"visible"===document.visibilityState&&(e.observeVisibility(),console.debug("Tab visible"))})}},{key:"observeVisibility",value:function(){var o=this,t=new IntersectionObserver(function(e){e.forEach(function(e){var t=e.target,n=o.trackedElements.get(t);e.isIntersecting&&!n?(n=o.createElementData(t)).content&&o.trackedElements.set(t,n):!e.isIntersecting&&n&&(o.addDataToSend(n),o.collectData(),o.trackedElements.delete(t))})},{threshold:.8});this.getTrackableElements().forEach(function(e){t.observe(e)})}},{key:"trackMouseOver",value:function(){var o=this;document.body.addEventListener("click",function(e){e=e.target;try{var t,n=o.trackedElements.get(e);n?null!=n&&n.clickCount?n.clickCount++:n.clickCount=1:(t=o.createElementData(e)).content&&(t.clickCount=1,o.trackedElements.set(e,t))}catch(e){console.log(e)}}),document.body.addEventListener("mouseover",function(e){e=e.target,e=o.trackedElements.get(e);e&&!e.mouseOverStartTime&&(e.mouseOverStartTime=Date.now())}),document.body.addEventListener("mouseout",function(e){e=e.target,e=o.trackedElements.get(e);e&&e.mouseOverStartTime&&(e.mouseOverDuration+=Date.now()-e.mouseOverStartTime,e.mouseOverStartTime=null)})}},{key:"trackTextSelection",value:function(){var n=this;document.addEventListener("selectionchange",function(){var e,t=window.getSelection();0<t.rangeCount&&((t=(e=t.getRangeAt(0)).toString().trim())&&(!(e=function(e){for(e.nodeType!==Node.ELEMENT_NODE&&(e=e.parentNode);e&&!d.includes(e.tagName.toLowerCase());)e=e.parentNode;return e&&d.includes(e.tagName.toLowerCase())?e:null}(e.commonAncestorContainer))||(e=n.trackedElements.get(e))&&(e.selectedText=t)))})}},{key:"getTrackableElements",value:function(){return Array.from(document.querySelectorAll("p, a, div, img[alt], h1, h2, h3, h4, h5, h6, pre, span, li, td, th, button, thin"))}},{key:"createElementData",value:function(e){var t=e.tagName.toLowerCase(),n="text";return"img"===t?n="image":"a"===t?n="link":"h1"===t?n="header":"pre"===t?n="quote":"li"===t&&(n="bullet"),{type:n,tag:t,content:("img"===e.tagName.toLowerCase()?e.alt:e.textContent.trim()).replace(/\s+/g," ").trim(),startTime:Date.now(),mouseOverDuration:0,mouseOverStartTime:null,selectedText:null,clickCount:0}}},{key:"appendElement",value:function(e,t){this.dataToSend.push({tag:e.tag,type:e.type,content:e.content,clickCount:e.clickCount,duration:t,mouseOverDuration:e.mouseOverDuration,selectedText:e.selectedText})}},{key:"addDataToSend",value:function(e){var t=Date.now(),n=t-e.startTime;e.mouseOverStartTime&&(e.mouseOverDuration+=t-e.mouseOverStartTime),this.appendElement(e,n)}},{key:"sendAllData",value:function(){var o,i=this;console.debug("Elements to send",this.trackedElements.size),0<this.trackedElements.size&&(o=Date.now(),this.trackedElements.forEach(function(e,t){var n=o-e.startTime;e.mouseOverStartTime&&(e.mouseOverDuration+=o-e.mouseOverStartTime),i.appendElement(e,n)}),this.dataSender.collectData(this.dataToSend),this.dataSender.sendData(!0),this.dataToSend=[],0===this.dataSender.pendingPayload.length&&this.trackedElements.clear())}},{key:"collectData",value:function(){this.dataSender.collectData(this.dataToSend),this.dataToSend=[]}}]),o}();document.addEventListener("DOMContentLoaded",function(){new g,console.log("[Tracardi Signals] Tracardi Signals loaded.")},!1)},{"./cookies":7,"./utils/hash":9,"@analytics/storage-utils":4}],9:[function(e,t,n){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),n.fnv1aHash=function(e,t,n){for(var o="".concat(e,":").concat(t,":").concat(n),i=2166136261,r=0;r<o.length;r++)i^=o.charCodeAt(r),i+=(i<<1)+(i<<4)+(i<<7)+(i<<8)+(i<<24);return(i>>>0).toString(16)}},{}]},{},[8])(8)});
//# sourceMappingURL=signal.min.js.map